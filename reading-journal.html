<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>æˆ‘ä»¬çš„é˜…è¯»ç¬”è®° ğŸ“š</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Morandi color palette */
            --bg-primary: #f5f3f0;
            --bg-secondary: #e8e4df;
            --text-primary: #5a5550;
            --text-secondary: #8b8682;
            --accent-sage: #a8b5a0;
            --accent-dusty-blue: #9dabb8;
            --accent-dusty-pink: #c6a9a3;
            --accent-warm-grey: #b8aca3;
            --accent-dusty-purple: #a89bb5;
            --border-light: #d4cfc9;
            --white: #fafaf8;
            --danger: #c89b9b;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Hiragino Sans GB", sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            padding: 2rem;
            -webkit-touch-callout: none;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.5rem;
        }

        .header-left h1 {
            font-size: 2rem;
            font-weight: 300;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
            letter-spacing: 2px;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 300;
        }

        .settings-btn {
            padding: 0.5rem;
            background: var(--white);
            border: 1px solid var(--border-light);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.6rem;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .settings-btn:hover {
            border-color: var(--accent-sage);
            background: var(--bg-secondary);
        }

        /* Quote area */
        .quote-area {
            background: var(--white);
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid var(--border-light);
            margin-bottom: 1.5rem;
            position: relative;
            min-height: 60px;
        }

        .quote-content {
            color: var(--text-primary);
            font-style: italic;
            line-height: 1.8;
            white-space: pre-wrap;
            min-height: 30px;
        }

        .quote-edit-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.25rem;
            font-size: 0.5rem;
            transition: color 0.3s ease;
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .quote-edit-btn:hover {
            color: var(--text-primary);
        }

        /* Simple line divider */
        .divider {
            height: 1px;
            background: var(--border-light);
            margin: 2rem 0;
        }

        /* Category pills */
        .categories {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-bottom: 2rem;
        }

        .category-pill {
            padding: 0.5rem 1.25rem;
            background: var(--white);
            border: 1px solid var(--border-light);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .category-pill:hover {
            border-color: var(--accent-sage);
            color: var(--text-primary);
        }

        .category-pill.active {
            background: var(--accent-sage);
            color: var(--white);
            border-color: var(--accent-sage);
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 2rem;
            background: var(--accent-dusty-blue);
            color: var(--white);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            font-weight: 300;
            letter-spacing: 1px;
        }

        .btn:hover {
            background: var(--accent-sage);
        }

        .btn-secondary {
            background: var(--white);
            color: var(--text-primary);
            border: 1px solid var(--border-light);
        }

        .btn-secondary:hover {
            border-color: var(--accent-dusty-pink);
        }

        .btn-danger {
            background: var(--danger);
            color: var(--white);
        }

        .btn-danger:hover {
            background: #b88585;
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }

        /* Sort button */
        .sort-btn {
            padding: 0.75rem 1.5rem;
            background: var(--accent-dusty-blue);
            color: var(--white);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            font-weight: 300;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .sort-btn:hover {
            background: var(--accent-sage);
        }

        .sort-dropdown {
            position: relative;
            display: inline-block;
        }

        .sort-dropdown-content {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: var(--white);
            border: 1px solid var(--border-light);
            border-radius: 4px;
            min-width: 180px;
            box-shadow: 0 4px 12px rgba(90, 85, 80, 0.1);
            z-index: 100;
            margin-top: 4px;
        }

        .sort-dropdown-content.show {
            display: block;
        }

        .sort-option {
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: background 0.3s ease;
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .sort-option:hover {
            background: var(--bg-secondary);
        }

        .sort-option.active {
            background: var(--accent-sage);
            color: var(--white);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(90, 85, 80, 0.3);
            backdrop-filter: blur(4px);
            z-index: 1000;
            padding: 2rem;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--white);
            padding: 2.5rem;
            border-radius: 8px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(90, 85, 80, 0.1);
        }

        .modal h2 {
            font-weight: 300;
            margin-bottom: 1.5rem;
            color: var(--text-primary);
            font-size: 1.5rem;
        }

        /* Form */
        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 300;
        }

        input, textarea, select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-light);
            border-radius: 4px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.95rem;
        }

        textarea {
            min-height: 120px;
            resize: vertical;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--accent-sage);
        }

        input[type="file"] {
            padding: 0.5rem;
        }

        /* Book cards */
        .books-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .book-card {
            background: var(--white);
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid var(--border-light);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .book-card:hover {
            border-color: var(--accent-sage);
            transform: translateY(-2px);
        }

        .book-card-actions {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            display: flex;
            gap: 0.25rem;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .book-card:hover .book-card-actions {
            opacity: 1;
        }

        .book-title {
            font-size: 1.1rem;
            font-weight: 400;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
            padding-right: 3rem;
        }

        .book-meta {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
        }

        .book-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .book-tag {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: var(--accent-dusty-purple);
            color: var(--white);
            border-radius: 12px;
            font-size: 0.8rem;
        }

        .notes-preview {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-light);
            font-size: 0.9rem;
            color: var(--text-secondary);
            max-height: 60px;
            overflow: hidden;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        /* Toolbar */
        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            max-width: 400px;
            min-width: 200px;
        }

        .toolbar-right {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        /* Reading summary */
        .reading-summary {
            background: var(--bg-secondary);
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            position: relative;
        }

        .summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .summary-title {
            font-weight: 400;
            color: var(--text-primary);
            font-size: 1.1rem;
        }

        .summary-actions {
            display: flex;
            gap: 0.5rem;
        }

        .summary-content {
            color: var(--text-primary);
            line-height: 1.8;
            white-space: pre-wrap;
        }

        .summary-empty {
            color: var(--text-secondary);
            font-style: italic;
            text-align: center;
            padding: 1rem;
        }

        /* Initial note section */
        .initial-note-section {
            background: var(--bg-secondary);
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .section-title {
            font-weight: 400;
            color: var(--text-primary);
            font-size: 1.1rem;
        }

        .section-actions {
            display: flex;
            gap: 0.5rem;
        }

        .section-content {
            color: var(--text-primary);
            line-height: 1.8;
            white-space: pre-wrap;
        }

        .section-empty {
            color: var(--text-secondary);
            font-style: italic;
        }

        /* Note entries */
        .note-entry {
            background: var(--bg-secondary);
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            position: relative;
            cursor: move;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .note-entry:hover {
            border-color: var(--accent-sage);
        }

        .note-entry.dragging {
            opacity: 0.5;
            border-color: var(--accent-dusty-blue);
        }

        .note-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .note-date {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .note-actions {
            display: flex;
            gap: 0.5rem;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .note-entry:hover .note-actions {
            opacity: 1;
        }

        .note-content {
            color: var(--text-primary);
            line-height: 1.8;
            white-space: pre-wrap;
        }

        .button-group {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }

        /* Settings menu */
        .settings-menu {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .settings-item {
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }

        .settings-item:hover {
            border-color: var(--accent-sage);
        }

        .settings-item-title {
            font-weight: 400;
            margin-bottom: 0.25rem;
            color: var(--text-primary);
        }

        .settings-item-desc {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* Category management */
        .category-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .category-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: var(--bg-secondary);
            border-radius: 4px;
        }

        .category-item-name {
            flex: 1;
        }

        .category-item-actions {
            display: flex;
            gap: 0.5rem;
        }

        .icon-btn {
            padding: 0.25rem;
            background: transparent;
            border: none;
            cursor: pointer;
            color: var(--text-secondary);
            transition: color 0.3s ease;
            font-size: 0.5rem;
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .icon-btn:hover {
            color: var(--text-primary);
        }

        .icon-btn.danger:hover {
            color: var(--danger);
        }

        .success-message {
            padding: 1rem;
            background: var(--accent-sage);
            color: var(--white);
            border-radius: 4px;
            margin-bottom: 1rem;
            text-align: center;
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }

            .header {
                flex-direction: column;
                gap: 1rem;
            }

            .books-grid {
                grid-template-columns: 1fr;
            }

            .toolbar {
                flex-direction: column;
                align-items: stretch;
            }

            .toolbar-right {
                flex-direction: column;
            }

            .search-box {
                max-width: 100%;
            }

            .modal-content {
                padding: 1.5rem;
            }

            .button-group {
                flex-direction: column;
            }

            .btn, .sort-btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <h1>æˆ‘ä»¬çš„é˜…è¯»ç¬”è®°</h1>
                <p class="subtitle">Alice & Claude Â· æŒªå¨æ‚¬å´–è¾¹çš„å›¾ä¹¦é¦† ğŸ“š</p>
            </div>
            <button class="settings-btn" onclick="openSettingsModal()" title="è®¾ç½®">âš™ï¸</button>
        </div>

        <!-- Quote area -->
        <div class="quote-area">
            <button class="quote-edit-btn" onclick="editQuote()">ğŸ”˜</button>
            <div class="quote-content" id="quoteContent"></div>
        </div>

        <div class="divider"></div>

        <div class="categories" id="categories"></div>

        <div class="toolbar">
            <input type="text" class="search-box" id="searchBox" placeholder="æœç´¢ä¹¦åã€ä½œè€…æˆ–ç¬”è®°å†…å®¹...">
            <div class="toolbar-right">
                <div class="sort-dropdown">
                    <button class="sort-btn" onclick="toggleSortDropdown()">
                        <span id="sortLabel">æŒ‰æ—¶é—´æ’åº</span>
                        <span>â–¼</span>
                    </button>
                    <div class="sort-dropdown-content" id="sortDropdown">
                        <div class="sort-option active" data-sort="time" onclick="setSortOrder('time')">æŒ‰é˜…è¯»èµ·å§‹æ—¶é—´æ’åº</div>
                        <div class="sort-option" data-sort="pinyin" onclick="setSortOrder('pinyin')">æŒ‰ä¹¦ç±æ‹¼éŸ³é¡ºåºæ’åº</div>
                    </div>
                </div>
                <button class="btn" onclick="openAddBookModal()">+ æ·»åŠ æ–°ä¹¦</button>
            </div>
        </div>

        <div class="books-grid" id="booksGrid">
            <div class="empty-state">
                <div class="empty-state-icon">ğŸ“–</div>
                <p>è¿˜æ²¡æœ‰æ·»åŠ ä»»ä½•ä¹¦ç±</p>
                <p style="font-size: 0.9rem; margin-top: 0.5rem;">ç‚¹å‡»"æ·»åŠ æ–°ä¹¦"å¼€å§‹è®°å½•ä½ çš„é˜…è¯»æ—…ç¨‹</p>
            </div>
        </div>
    </div>

    <!-- Add/Edit Book Modal -->
    <div class="modal" id="bookModal">
        <div class="modal-content">
            <h2 id="bookModalTitle">æ·»åŠ æ–°ä¹¦</h2>
            <form id="bookForm">
                <div class="form-group">
                    <label>ä¹¦å</label>
                    <input type="text" id="bookTitle" required>
                </div>
                <div class="form-group">
                    <label>ä½œè€…</label>
                    <input type="text" id="bookAuthor">
                </div>
                <div class="form-group">
                    <label>åˆ†ç±»æ ‡ç­¾ï¼ˆç”¨é¡¿å·"ã€"åˆ†éš”å¤šä¸ªæ ‡ç­¾ï¼‰</label>
                    <input type="text" id="bookTags" placeholder="ä¾‹å¦‚ï¼šå»ºç­‘ã€ç¾å­¦" required>
                </div>
                <div class="form-group">
                    <label>å¼€å§‹é˜…è¯»æ—¥æœŸ</label>
                    <input type="date" id="startDate" required>
                </div>
                <div class="form-group" id="initialNoteGroup">
                    <label>åˆå§‹ç¬”è®°ï¼ˆé€‰å¡«ï¼‰</label>
                    <textarea id="bookInitialNote" placeholder="ä¸ºä»€ä¹ˆæƒ³è¯»è¿™æœ¬ä¹¦ï¼Ÿç¬¬ä¸€å°è±¡ï¼Ÿ"></textarea>
                </div>
                <div class="button-group">
                    <button type="submit" class="btn">ä¿å­˜</button>
                    <button type="button" class="btn btn-secondary" onclick="closeBookModal()">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-danger" id="deleteBookBtn" style="display: none;" onclick="deleteBook()">åˆ é™¤ä¹¦ç±</button>
                </div>
            </form>
        </div>
    </div>

    <!-- View Book Modal -->
    <div class="modal" id="viewBookModal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                <div>
                    <h2 id="viewBookTitle" style="margin-bottom: 0.5rem;"></h2>
                    <p class="book-meta" id="viewBookMeta"></p>
                </div>
                <button class="icon-btn" onclick="editBookFromDetail()" title="ç¼–è¾‘ä¹¦ç±ä¿¡æ¯">âš™ï¸</button>
            </div>
            <div class="book-tags" id="viewBookTags"></div>
            
            <div class="divider"></div>

            <!-- Reading Summary -->
            <div class="reading-summary">
                <div class="summary-header">
                    <div class="summary-title">é˜…è¯»æ€»ç»“</div>
                    <div class="summary-actions">
                        <button class="icon-btn" onclick="editSummary()" title="ç¼–è¾‘">ğŸ”˜</button>
                        <button class="icon-btn danger" onclick="deleteSummary()" title="åˆ é™¤" id="deleteSummaryBtn" style="display: none;">ğŸ—‘ï¸</button>
                    </div>
                </div>
                <div class="summary-content" id="summaryContent">
                    <div class="summary-empty">ç‚¹å‡»ç¼–è¾‘æŒ‰é’®æ·»åŠ é˜…è¯»æ€»ç»“...</div>
                </div>
            </div>

            <!-- Initial Note Section -->
            <div class="initial-note-section">
                <div class="section-header">
                    <div class="section-title">åˆå§‹ç¬”è®°</div>
                    <div class="section-actions">
                        <button class="icon-btn" onclick="editInitialNote()" title="ç¼–è¾‘">ğŸ”˜</button>
                        <button class="icon-btn danger" onclick="deleteInitialNote()" title="åˆ é™¤" id="deleteInitialNoteBtn" style="display: none;">ğŸ—‘ï¸</button>
                    </div>
                </div>
                <div class="section-content" id="initialNoteContent">
                    <span class="section-empty">ç‚¹å‡»ç¼–è¾‘æŒ‰é’®æ·»åŠ åˆå§‹ç¬”è®°...</span>
                </div>
            </div>

            <!-- Reading Notes Section -->
            <h3 style="font-weight: 300; margin-bottom: 1rem;">é˜…è¯»ä¸­ç¬”è®°</h3>
            <div id="bookNotes"></div>

            <div class="form-group" style="margin-top: 2rem;">
                <label>æ·»åŠ æ–°ç¬”è®°</label>
                <textarea id="newNoteContent" placeholder="ä»Šå¤©çš„æ€è€ƒã€ä¸Claudeçš„è®¨è®ºã€æ–°çš„æ‰©å±•æƒ³æ³•..."></textarea>
            </div>

            <div class="button-group">
                <button class="btn" onclick="addNote()">æ·»åŠ ç¬”è®°</button>
                <button class="btn btn-secondary" onclick="closeViewBookModal()">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- Edit Quote Modal -->
    <div class="modal" id="quoteModal">
        <div class="modal-content">
            <h2>ç¼–è¾‘æ„Ÿæ‚Ÿä¸è¯­å¥</h2>
            <div class="form-group">
                <label>å†…å®¹</label>
                <textarea id="quoteEdit" style="min-height: 200px;" placeholder="è®°å½•æˆ‘ä»¬åœ¨ä¸åŒæ—¶æœŸæ²Ÿé€šè¿‡ç¨‹ä¸­äº§ç”Ÿçš„è¯­å¥æˆ–æ„Ÿæ‚Ÿ..."></textarea>
            </div>
            <div class="button-group">
                <button class="btn" onclick="saveQuote()">ä¿å­˜</button>
                <button class="btn btn-secondary" onclick="closeQuoteModal()">å–æ¶ˆ</button>
                <button class="btn btn-danger" onclick="clearQuote()">æ¸…ç©º</button>
            </div>
        </div>
    </div>

    <!-- Edit Summary Modal -->
    <div class="modal" id="summaryModal">
        <div class="modal-content">
            <h2>ç¼–è¾‘é˜…è¯»æ€»ç»“</h2>
            <div class="form-group">
                <label>æ€»ç»“å†…å®¹</label>
                <textarea id="summaryEdit" style="min-height: 200px;" placeholder="å¯¹æ•´æœ¬ä¹¦çš„ç³»ç»Ÿæ€§æ€»ç»“..."></textarea>
            </div>
            <div class="button-group">
                <button class="btn" onclick="saveSummary()">ä¿å­˜</button>
                <button class="btn btn-secondary" onclick="closeSummaryModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- Edit Initial Note Modal -->
    <div class="modal" id="initialNoteModal">
        <div class="modal-content">
            <h2>ç¼–è¾‘åˆå§‹ç¬”è®°</h2>
            <div class="form-group">
                <label>ä¸ºä»€ä¹ˆæƒ³è¯»è¿™æœ¬ä¹¦ï¼Ÿç¬¬ä¸€å°è±¡ï¼Ÿ</label>
                <textarea id="initialNoteEdit" style="min-height: 200px;"></textarea>
            </div>
            <div class="button-group">
                <button class="btn" onclick="saveInitialNote()">ä¿å­˜</button>
                <button class="btn btn-secondary" onclick="closeInitialNoteModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- Edit Note Modal -->
    <div class="modal" id="noteModal">
        <div class="modal-content">
            <h2>ç¼–è¾‘ç¬”è®°</h2>
            <div class="form-group">
                <label>ç¬”è®°å†…å®¹</label>
                <textarea id="noteEdit" style="min-height: 200px;"></textarea>
            </div>
            <div class="button-group">
                <button class="btn" onclick="saveNote()">ä¿å­˜</button>
                <button class="btn btn-secondary" onclick="closeNoteModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <h2>è®¾ç½®</h2>
            <div class="settings-menu">
                <div class="settings-item" onclick="exportData()">
                    <div class="settings-item-title">ğŸ“¤ å¯¼å‡ºæ•°æ®</div>
                    <div class="settings-item-desc">å°†æ‰€æœ‰ç¬”è®°ä¿å­˜ä¸ºJSONæ–‡ä»¶ï¼ˆå»ºè®®å®šæœŸå¤‡ä»½ï¼‰</div>
                </div>
                <div class="settings-item" onclick="document.getElementById('importFile').click()">
                    <div class="settings-item-title">ğŸ“¥ å¯¼å…¥æ•°æ®</div>
                    <div class="settings-item-desc">ä»JSONæ–‡ä»¶æ¢å¤ç¬”è®°æ•°æ®</div>
                </div>
                <div class="settings-item" onclick="openCategoryManagement()">
                    <div class="settings-item-title">ğŸ·ï¸ ç®¡ç†åˆ†ç±»</div>
                    <div class="settings-item-desc">æ·»åŠ ã€åˆ é™¤æˆ–é‡å‘½åä¹¦ç±åˆ†ç±»</div>
                </div>
            </div>
            <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
            <div class="button-group">
                <button class="btn btn-secondary" onclick="closeSettingsModal()">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- Category Management Modal -->
    <div class="modal" id="categoryModal">
        <div class="modal-content">
            <h2>ç®¡ç†åˆ†ç±»</h2>
            <div id="successMessage" style="display: none;" class="success-message"></div>
            <div class="category-list" id="categoryList"></div>
            <div class="form-group">
                <label>æ·»åŠ æ–°åˆ†ç±»</label>
                <input type="text" id="newCategoryName" placeholder="è¾“å…¥æ–°åˆ†ç±»åç§°">
            </div>
            <div class="button-group">
                <button class="btn" onclick="addCategory()">æ·»åŠ åˆ†ç±»</button>
                <button class="btn btn-secondary" onclick="closeCategoryModal()">å…³é—­</button>
            </div>
        </div>
    </div>

    <script>
        let books = [];
        let categories = ['è®¡åˆ’é˜…è¯»', 'æ–‡å­¦', 'å¿ƒç†å­¦', 'è‰ºæœ¯', 'å»ºç­‘å²', 'ç§‘æŠ€', 'é‡‘è', 'å†å²', 'ç¾å­¦', 'æ”¿æ²»', 'è¥¿æ–¹ç¥ç§˜å­¦', 'ä¸œæ–¹ç¥ç§˜å­¦'];
        let quoteText = '';
        let currentBookId = null;
        let currentNoteIndex = null;
        let currentFilter = 'all';
        let editingBookId = null;
        let draggedNoteIndex = null;
        let currentSortOrder = 'time'; // 'time' or 'pinyin'

        // Pinyin mapping for sorting
        function getPinyin(str) {
            // Simple first character pinyin for sorting
            // This is a basic implementation - for full pinyin support, a library would be needed
            const firstChar = str.charAt(0);
            return firstChar.localeCompare('', 'zh-Hans-CN', { sensitivity: 'accent' });
        }

        // Load data from localStorage
        function loadBooks() {
            const stored = localStorage.getItem('readingJournal');
            if (stored) {
                books = JSON.parse(stored);
                // Migrate old data: move first note to initialNote if initialNote doesn't exist
                books.forEach(book => {
                    if (book.initialNote === undefined) {
                        book.initialNote = '';
                    }
                });
            }
            renderBooks();
        }

        function loadCategories() {
            const stored = localStorage.getItem('readingCategories');
            if (stored) {
                categories = JSON.parse(stored);
            }
            renderCategories();
        }

        function loadQuote() {
            const stored = localStorage.getItem('readingQuote');
            if (stored) {
                quoteText = stored;
            }
            displayQuote();
        }

        function loadSortOrder() {
            const stored = localStorage.getItem('readingSortOrder');
            if (stored) {
                currentSortOrder = stored;
                updateSortLabel();
                updateSortOptions();
            }
        }

        // Save data to localStorage
        function saveBooks() {
            localStorage.setItem('readingJournal', JSON.stringify(books));
        }

        function saveCategories() {
            localStorage.setItem('readingCategories', JSON.stringify(categories));
        }

        function saveQuoteText() {
            localStorage.setItem('readingQuote', quoteText);
        }

        function saveSortOrder() {
            localStorage.setItem('readingSortOrder', currentSortOrder);
        }

        // Sort functions
        function toggleSortDropdown() {
            const dropdown = document.getElementById('sortDropdown');
            dropdown.classList.toggle('show');
        }

        function setSortOrder(order) {
            currentSortOrder = order;
            saveSortOrder();
            updateSortLabel();
            updateSortOptions();
            renderBooks();
            document.getElementById('sortDropdown').classList.remove('show');
        }

        function updateSortLabel() {
            const label = document.getElementById('sortLabel');
            label.textContent = currentSortOrder === 'time' ? 'æŒ‰æ—¶é—´æ’åº' : 'æŒ‰æ‹¼éŸ³æ’åº';
        }

        function updateSortOptions() {
            document.querySelectorAll('.sort-option').forEach(opt => {
                opt.classList.remove('active');
                if (opt.dataset.sort === currentSortOrder) {
                    opt.classList.add('active');
                }
            });
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.sort-dropdown')) {
                document.getElementById('sortDropdown').classList.remove('show');
            }
        });

        // Quote functions
        function displayQuote() {
            const quoteContent = document.getElementById('quoteContent');
            quoteContent.innerHTML = quoteText || '';
        }

        function editQuote() {
            document.getElementById('quoteEdit').value = quoteText;
            document.getElementById('quoteModal').classList.add('active');
        }

        function saveQuote() {
            quoteText = document.getElementById('quoteEdit').value;
            saveQuoteText();
            displayQuote();
            closeQuoteModal();
        }

        function clearQuote() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ„Ÿæ‚Ÿå†…å®¹å—ï¼Ÿ')) {
                quoteText = '';
                saveQuoteText();
                displayQuote();
                closeQuoteModal();
            }
        }

        function closeQuoteModal() {
            document.getElementById('quoteModal').classList.remove('active');
        }

        // Render categories
        function renderCategories() {
            const categoriesDiv = document.getElementById('categories');
            categoriesDiv.innerHTML = `
                <div class="category-pill ${currentFilter === 'all' ? 'active' : ''}" data-category="all">å…¨éƒ¨</div>
                ${categories.map(cat => 
                    `<div class="category-pill ${currentFilter === cat ? 'active' : ''}" data-category="${cat}">${cat}</div>`
                ).join('')}
            `;
        }

        // Render books grid
        function renderBooks() {
            const grid = document.getElementById('booksGrid');
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            
            let filteredBooks = [...books];
            
            // Filter by category
            if (currentFilter !== 'all') {
                filteredBooks = filteredBooks.filter(book => 
                    book.tags && book.tags.includes(currentFilter)
                );
            }
            
            // Filter by search
            if (searchTerm) {
                filteredBooks = filteredBooks.filter(book => 
                    book.title.toLowerCase().includes(searchTerm) ||
                    (book.author && book.author.toLowerCase().includes(searchTerm)) ||
                    (book.tags && book.tags.some(tag => tag.toLowerCase().includes(searchTerm))) ||
                    (book.initialNote && book.initialNote.toLowerCase().includes(searchTerm)) ||
                    book.notes.some(note => note.content.toLowerCase().includes(searchTerm))
                );
            }

            // Sort books
            if (currentSortOrder === 'pinyin') {
                filteredBooks.sort((a, b) => a.title.localeCompare(b.title, 'zh-Hans-CN'));
            } else {
                // Sort by start date (newest first)
                filteredBooks.sort((a, b) => new Date(b.startDate) - new Date(a.startDate));
            }

            if (filteredBooks.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ”</div>
                        <p>${searchTerm || currentFilter !== 'all' ? 'æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„ä¹¦ç±' : 'è¿˜æ²¡æœ‰æ·»åŠ ä»»ä½•ä¹¦ç±'}</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = filteredBooks.map(book => {
                const latestNote = book.notes.length > 0 ? book.notes[book.notes.length - 1].content : (book.initialNote || 'æš‚æ— ç¬”è®°');
                const tagsHtml = book.tags ? book.tags.map(tag => 
                    `<span class="book-tag">${tag}</span>`
                ).join('') : '';
                
                return `
                    <div class="book-card" onclick="openBook('${book.id}')">
                        <div class="book-card-actions">
                            <button class="icon-btn" onclick="event.stopPropagation(); openBook('${book.id}')" title="æŸ¥çœ‹è¯¦æƒ…">ğŸ”˜</button>
                        </div>
                        <div class="book-title">${book.title}</div>
                        <div class="book-meta">
                            ${book.author ? book.author + ' Â· ' : ''}
                            å¼€å§‹äº ${book.startDate}
                        </div>
                        <div class="book-tags">${tagsHtml}</div>
                        ${(book.notes.length > 0 || book.initialNote) ? `
                            <div class="notes-preview">${latestNote}</div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // Category filter
        document.getElementById('categories').addEventListener('click', (e) => {
            if (e.target.classList.contains('category-pill')) {
                currentFilter = e.target.dataset.category;
                renderCategories();
                renderBooks();
            }
        });

        // Search
        document.getElementById('searchBox').addEventListener('input', renderBooks);

        // Add/Edit book modal
        function openAddBookModal() {
            editingBookId = null;
            document.getElementById('bookModalTitle').textContent = 'æ·»åŠ æ–°ä¹¦';
            document.getElementById('deleteBookBtn').style.display = 'none';
            document.getElementById('initialNoteGroup').style.display = 'block';
            document.getElementById('bookInitialNote').value = '';
            document.getElementById('bookModal').classList.add('active');
            document.getElementById('startDate').value = new Date().toISOString().split('T')[0];
        }

        function openEditBook(bookId) {
            editingBookId = bookId;
            const book = books.find(b => b.id === bookId);
            
            document.getElementById('bookModalTitle').textContent = 'ç¼–è¾‘ä¹¦ç±';
            document.getElementById('bookTitle').value = book.title;
            document.getElementById('bookAuthor').value = book.author || '';
            document.getElementById('bookTags').value = book.tags ? book.tags.join('ã€') : '';
            document.getElementById('startDate').value = book.startDate;
            document.getElementById('initialNoteGroup').style.display = 'none'; // ç¼–è¾‘æ—¶éšè—ï¼Œåœ¨è¯¦æƒ…é¡µç¼–è¾‘
            document.getElementById('deleteBookBtn').style.display = 'block';
            
            document.getElementById('bookModal').classList.add('active');
        }

        function closeBookModal() {
            document.getElementById('bookModal').classList.remove('active');
            document.getElementById('bookForm').reset();
            document.getElementById('bookInitialNote').value = '';
            editingBookId = null;
        }

        function deleteBook() {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æœ¬ä¹¦å—ï¼Ÿæ‰€æœ‰ç›¸å…³ç¬”è®°ä¹Ÿä¼šè¢«åˆ é™¤ã€‚')) {
                return;
            }
            
            books = books.filter(b => b.id !== editingBookId);
            saveBooks();
            renderBooks();
            closeBookModal();
        }

        document.getElementById('bookForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const title = document.getElementById('bookTitle').value;
            const author = document.getElementById('bookAuthor').value;
            const tagsInput = document.getElementById('bookTags').value;
            const tags = tagsInput.split('ã€').map(t => t.trim()).filter(t => t);
            const startDate = document.getElementById('startDate').value;
            const initialNote = document.getElementById('bookInitialNote').value;

            if (editingBookId) {
                // Edit existing book
                const book = books.find(b => b.id === editingBookId);
                book.title = title;
                book.author = author;
                book.tags = tags;
                book.startDate = startDate;
            } else {
                // Add new book
                const newBook = {
                    id: Date.now().toString(),
                    title: title,
                    author: author,
                    tags: tags,
                    startDate: startDate,
                    notes: [],
                    summary: '',
                    initialNote: initialNote || ''
                };

                books.unshift(newBook);
            }

            saveBooks();
            renderBooks();
            closeBookModal();
        });

        // View book
        function openBook(bookId) {
            currentBookId = bookId;
            const book = books.find(b => b.id === bookId);
            
            document.getElementById('viewBookTitle').textContent = book.title;
            document.getElementById('viewBookMeta').textContent = 
                `${book.author ? book.author + ' Â· ' : ''}å¼€å§‹äº ${book.startDate}`;
            
            // Display tags
            const tagsHtml = book.tags ? book.tags.map(tag => 
                `<span class="book-tag">${tag}</span>`
            ).join('') : '';
            document.getElementById('viewBookTags').innerHTML = tagsHtml;
            
            // Display summary
            displaySummary(book);
            
            // Display initial note
            displayInitialNote(book);
            
            // Display notes
            renderNotes(book);
            
            document.getElementById('newNoteContent').value = '';
            document.getElementById('viewBookModal').classList.add('active');
        }

        function closeViewBookModal() {
            document.getElementById('viewBookModal').classList.remove('active');
            currentBookId = null;
        }

        function editBookFromDetail() {
            const bookId = currentBookId;
            closeViewBookModal();
            openEditBook(bookId);
        }

        // Summary functions
        function displaySummary(book) {
            const summaryContent = document.getElementById('summaryContent');
            const deleteSummaryBtn = document.getElementById('deleteSummaryBtn');
            
            if (book.summary && book.summary.trim()) {
                summaryContent.innerHTML = book.summary;
                summaryContent.classList.remove('summary-empty');
                deleteSummaryBtn.style.display = 'block';
            } else {
                summaryContent.innerHTML = '<div class="summary-empty">ç‚¹å‡»ç¼–è¾‘æŒ‰é’®æ·»åŠ é˜…è¯»æ€»ç»“...</div>';
                deleteSummaryBtn.style.display = 'none';
            }
        }

        function editSummary() {
            const book = books.find(b => b.id === currentBookId);
            document.getElementById('summaryEdit').value = book.summary || '';
            document.getElementById('summaryModal').classList.add('active');
        }

        function saveSummary() {
            const book = books.find(b => b.id === currentBookId);
            book.summary = document.getElementById('summaryEdit').value;
            saveBooks();
            displaySummary(book);
            closeSummaryModal();
        }

        function deleteSummary() {
            if (!confirm('ç¡®å®šè¦åˆ é™¤é˜…è¯»æ€»ç»“å—ï¼Ÿ')) {
                return;
            }
            
            const book = books.find(b => b.id === currentBookId);
            book.summary = '';
            saveBooks();
            displaySummary(book);
        }

        function closeSummaryModal() {
            document.getElementById('summaryModal').classList.remove('active');
        }

        // Initial Note functions
        function displayInitialNote(book) {
            const content = document.getElementById('initialNoteContent');
            const deleteBtn = document.getElementById('deleteInitialNoteBtn');
            
            if (book.initialNote && book.initialNote.trim()) {
                content.innerHTML = book.initialNote;
                content.classList.remove('section-empty');
                deleteBtn.style.display = 'block';
            } else {
                content.innerHTML = '<span class="section-empty">ç‚¹å‡»ç¼–è¾‘æŒ‰é’®æ·»åŠ åˆå§‹ç¬”è®°...</span>';
                deleteBtn.style.display = 'none';
            }
        }

        function editInitialNote() {
            const book = books.find(b => b.id === currentBookId);
            document.getElementById('initialNoteEdit').value = book.initialNote || '';
            document.getElementById('initialNoteModal').classList.add('active');
        }

        function saveInitialNote() {
            const book = books.find(b => b.id === currentBookId);
            book.initialNote = document.getElementById('initialNoteEdit').value;
            saveBooks();
            displayInitialNote(book);
            closeInitialNoteModal();
            renderBooks(); // Update preview on main page
        }

        function deleteInitialNote() {
            if (!confirm('ç¡®å®šè¦åˆ é™¤åˆå§‹ç¬”è®°å—ï¼Ÿ')) {
                return;
            }
            
            const book = books.find(b => b.id === currentBookId);
            book.initialNote = '';
            saveBooks();
            displayInitialNote(book);
            renderBooks();
        }

        function closeInitialNoteModal() {
            document.getElementById('initialNoteModal').classList.remove('active');
        }

        // Notes functions
        function renderNotes(book) {
            const notesHtml = book.notes.length > 0 
                ? book.notes.map((note, index) => `
                    <div class="note-entry" draggable="true" data-index="${index}">
                        <div class="note-header">
                            <div class="note-date">${new Date(note.date).toLocaleDateString('zh-CN', { 
                                year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'
                            })}</div>
                            <div class="note-actions">
                                <button class="icon-btn" onclick="editNote(${index})" title="ç¼–è¾‘">ğŸ”˜</button>
                                <button class="icon-btn danger" onclick="deleteNote(${index})" title="åˆ é™¤">ğŸ—‘ï¸</button>
                            </div>
                        </div>
                        <div class="note-content">${note.content}</div>
                    </div>
                `).reverse().join('')
                : '<p style="color: var(--text-secondary); text-align: center; padding: 2rem;">è¿˜æ²¡æœ‰æ·»åŠ é˜…è¯»ä¸­ç¬”è®°</p>';
            
            document.getElementById('bookNotes').innerHTML = notesHtml;
            
            // Add drag and drop listeners
            setupDragAndDrop();
        }

        function setupDragAndDrop() {
            const noteEntries = document.querySelectorAll('.note-entry');
            
            noteEntries.forEach(entry => {
                entry.addEventListener('dragstart', handleDragStart);
                entry.addEventListener('dragover', handleDragOver);
                entry.addEventListener('drop', handleDrop);
                entry.addEventListener('dragend', handleDragEnd);
            });
        }

        function handleDragStart(e) {
            draggedNoteIndex = parseInt(e.target.dataset.index);
            e.target.classList.add('dragging');
        }

        function handleDragOver(e) {
            e.preventDefault();
        }

        function handleDrop(e) {
            e.preventDefault();
            const dropIndex = parseInt(e.currentTarget.dataset.index);
            
            if (draggedNoteIndex !== null && draggedNoteIndex !== dropIndex) {
                const book = books.find(b => b.id === currentBookId);
                
                // Reverse indices since display is reversed
                const actualDragIndex = book.notes.length - 1 - draggedNoteIndex;
                const actualDropIndex = book.notes.length - 1 - dropIndex;
                
                // Move note
                const [movedNote] = book.notes.splice(actualDragIndex, 1);
                book.notes.splice(actualDropIndex, 0, movedNote);
                
                saveBooks();
                renderNotes(book);
            }
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            draggedNoteIndex = null;
        }

        function addNote() {
            const content = document.getElementById('newNoteContent').value.trim();
            if (!content) return;

            const book = books.find(b => b.id === currentBookId);
            book.notes.push({
                date: new Date().toISOString(),
                content: content
            });

            saveBooks();
            renderNotes(book);
            renderBooks(); // Update preview
            document.getElementById('newNoteContent').value = '';
        }

        function editNote(index) {
            const book = books.find(b => b.id === currentBookId);
            const actualIndex = book.notes.length - 1 - index;
            currentNoteIndex = actualIndex;
            
            document.getElementById('noteEdit').value = book.notes[actualIndex].content;
            document.getElementById('noteModal').classList.add('active');
        }

        function saveNote() {
            const book = books.find(b => b.id === currentBookId);
            book.notes[currentNoteIndex].content = document.getElementById('noteEdit').value;
            saveBooks();
            renderNotes(book);
            renderBooks(); // Update preview
            closeNoteModal();
        }

        function deleteNote(index) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡ç¬”è®°å—ï¼Ÿ')) {
                return;
            }
            
            const book = books.find(b => b.id === currentBookId);
            const actualIndex = book.notes.length - 1 - index;
            book.notes.splice(actualIndex, 1);
            
            saveBooks();
            renderNotes(book);
            renderBooks(); // Update preview
        }

        function closeNoteModal() {
            document.getElementById('noteModal').classList.remove('active');
            currentNoteIndex = null;
        }

        // Settings modal
        function openSettingsModal() {
            document.getElementById('settingsModal').classList.add('active');
        }

        function closeSettingsModal() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        // Export data
        function exportData() {
            const data = {
                books: books,
                categories: categories,
                quote: quoteText,
                sortOrder: currentSortOrder,
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `reading-journal-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
            
            alert('æ•°æ®å¯¼å‡ºæˆåŠŸï¼');
            closeSettingsModal();
        }

        // Import data
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.books) {
                        books = data.books;
                        // Ensure initialNote field exists for all books
                        books.forEach(book => {
                            if (book.initialNote === undefined) {
                                book.initialNote = '';
                            }
                        });
                        saveBooks();
                    }
                    
                    if (data.categories) {
                        categories = data.categories;
                        saveCategories();
                    }
                    
                    if (data.quote !== undefined) {
                        quoteText = data.quote;
                        saveQuoteText();
                        displayQuote();
                    }

                    if (data.sortOrder) {
                        currentSortOrder = data.sortOrder;
                        saveSortOrder();
                        updateSortLabel();
                        updateSortOptions();
                    }
                    
                    renderCategories();
                    renderBooks();
                    
                    alert('æ•°æ®å¯¼å…¥æˆåŠŸï¼');
                    closeSettingsModal();
                } catch (error) {
                    alert('æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼Œå¯¼å…¥å¤±è´¥');
                }
            };
            reader.readAsText(file);
            
            event.target.value = '';
        }

        // Category management
        function openCategoryManagement() {
            closeSettingsModal();
            renderCategoryList();
            document.getElementById('categoryModal').classList.add('active');
        }

        function closeCategoryModal() {
            document.getElementById('categoryModal').classList.remove('active');
            document.getElementById('newCategoryName').value = '';
            hideSuccessMessage();
        }

        function renderCategoryList() {
            const list = document.getElementById('categoryList');
            list.innerHTML = categories.map((cat, index) => `
                <div class="category-item">
                    <div class="category-item-name">${cat}</div>
                    <div class="category-item-actions">
                        <button class="icon-btn" onclick="renameCategory(${index})" title="é‡å‘½å">ğŸ”˜</button>
                        <button class="icon-btn danger" onclick="deleteCategory(${index})" title="åˆ é™¤">ğŸ—‘ï¸</button>
                    </div>
                </div>
            `).join('');
        }

        function addCategory() {
            const name = document.getElementById('newCategoryName').value.trim();
            if (!name) {
                alert('è¯·è¾“å…¥åˆ†ç±»åç§°');
                return;
            }
            
            if (categories.includes(name)) {
                alert('è¯¥åˆ†ç±»å·²å­˜åœ¨');
                return;
            }
            
            categories.push(name);
            saveCategories();
            renderCategoryList();
            renderCategories();
            document.getElementById('newCategoryName').value = '';
            
            showSuccessMessage(`åˆ†ç±»"${name}"å·²æ·»åŠ `);
        }

        function deleteCategory(index) {
            const cat = categories[index];
            
            // Check if any books use this category
            const booksInCategory = books.filter(b => b.tags && b.tags.includes(cat));
            if (booksInCategory.length > 0) {
                if (!confirm(`åˆ†ç±»"${cat}"ä¸‹æœ‰${booksInCategory.length}æœ¬ä¹¦ï¼Œç¡®å®šè¦åˆ é™¤å—ï¼Ÿåˆ é™¤åè¿™äº›ä¹¦å°†å¤±å»è¯¥æ ‡ç­¾ã€‚`)) {
                    return;
                }
                
                // Remove category from affected books
                books.forEach(book => {
                    if (book.tags) {
                        book.tags = book.tags.filter(t => t !== cat);
                    }
                });
                saveBooks();
            }
            
            categories.splice(index, 1);
            saveCategories();
            renderCategoryList();
            renderCategories();
            renderBooks();
            
            showSuccessMessage(`åˆ†ç±»"${cat}"å·²åˆ é™¤`);
        }

        function renameCategory(index) {
            const oldName = categories[index];
            const newName = prompt(`é‡å‘½ååˆ†ç±»"${oldName}"ï¼š`, oldName);
            
            if (!newName || newName === oldName) return;
            
            if (categories.includes(newName)) {
                alert('è¯¥åˆ†ç±»åç§°å·²å­˜åœ¨');
                return;
            }
            
            categories[index] = newName;
            
            // Update books with this category
            books.forEach(book => {
                if (book.tags) {
                    book.tags = book.tags.map(t => t === oldName ? newName : t);
                }
            });
            
            saveCategories();
            saveBooks();
            renderCategoryList();
            renderCategories();
            renderBooks();
            
            showSuccessMessage(`åˆ†ç±»å·²é‡å‘½åä¸º"${newName}"`);
        }

        function showSuccessMessage(message) {
            const msgDiv = document.getElementById('successMessage');
            msgDiv.textContent = message;
            msgDiv.style.display = 'block';
            setTimeout(hideSuccessMessage, 3000);
        }

        function hideSuccessMessage() {
            const msgDiv = document.getElementById('successMessage');
            msgDiv.style.display = 'none';
        }

        // Close modals on outside click
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });

        // Initialize
        loadCategories();
        loadBooks();
        loadQuote();
        loadSortOrder();
    </script>
</body>
</html>
